<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reveal Your Role | Werewolf</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="player-view">
    <!-- Background Effects -->
    <div class="ambient-glow" id="roleGlow"></div>

    <div class="container player-container">
      
      <!-- 3D Flipping Card -->
      <div class="scene scene--card">
        <div class="card" id="roleCard">
          
          <!-- Card Back (Hidden default state) -->
          <div class="card__face card__face--back glass-panel">
            <div class="card-back-content">
              <i class="fa-solid fa-moon moon-logo"></i>
              <h2>Werewolf</h2>
              <p>Your secret role awaits</p>
              <div class="tap-hint">
                <i class="fa-solid fa-hand-pointer pulse-anim"></i>
                <span>Tap to Reveal</span>
              </div>
            </div>
          </div>

          <!-- Card Front (Revealed state) -->
          <div class="card__face card__face--front glass-panel">
            <div class="role-display">
              <div class="corner-pin top-left"></div>
              <div class="corner-pin top-right"></div>
              
              <div id="playerName" class="player-name-badge"></div>
              
              <div class="role-icon-wrapper">
                <i class="fa-solid fa-question" id="roleIconFA"></i>
                <span id="roleIconEmoji" style="display:none">üé≠</span>
              </div>
              
              <h1 id="roleName" class="role-title">Loading...</h1>
              <div class="role-divider"></div>
              
              <div class="role-description" id="roleDescription">Decrypting role...</div>
              <div class="role-detailed-description" id="roleDetailedDescription"></div>
              
              <div id="werewolfTeam" class="werewolf-team glass-panel-inner" style="display: none">
                <h3><i class="fa-solid fa-users"></i> The Pack:</h3>
                <div id="werewolfTeammates" class="teammates-list"></div>
              </div>
              
              <div class="corner-pin bottom-left"></div>
              <div class="corner-pin bottom-right"></div>
            </div>
          </div>

        </div>
      </div>

      <div class="player-controls">
        <button id="hideRevealBtn" class="btn btn-primary btn-glow" style="display:none">
          <i class="fa-solid fa-eye-slash"></i> Hide Role
        </button>
        <button id="roleInfoBtn" class="btn btn-outline">
          <i class="fa-solid fa-book-open"></i> Role Guide
        </button>
      </div>

      <!-- Player Notes Section -->
      <div class="player-notes-section glass-panel-inner">
        <h3><i class="fa-solid fa-pen-nib"></i> Detective Notes</h3>
        <textarea id="playerNotes" class="custom-textarea custom-scrollbar" placeholder="Scribble your suspicions here..."></textarea>
        <div class="notes-buttons">
          <button id="savePlayerNotesBtn" class="btn btn-success btn-sm"><i class="fa-solid fa-floppy-disk"></i> Save</button>
          <button id="clearPlayerNotesBtn" class="btn btn-danger btn-sm"><i class="fa-solid fa-trash"></i> Clear</button>
        </div>
      </div>

      <div class="player-info-footer">
        <p>Identifier: <span id="playerNumber" class="badge-text">-</span></p>
      </div>
      
      <!-- Audio (Optional) -->
      <audio id="heartbeatSound" src="https://assets.mixkit.co/active_storage/sfx/2857/2857-preview.mp3" preload="auto"></audio>
    </div>

    <script>
      // Custom Modal UI
      function showCustomModal(options) {
        const { title = "Alert", message, isConfirm = false, onConfirm, onCancel, confirmText = "OK", cancelText = "Cancel" } = options;
        
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(2, 6, 23, 0.85);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
        `;

        const modalContent = document.createElement("div");
        modalContent.className = "glass-panel-inner";
        modalContent.style.cssText = `
          background: rgba(15, 23, 42, 0.95);
          padding: 2rem;
          border-radius: var(--radius-md);
          border: 1px solid var(--glass-border);
          max-width: 400px;
          width: 90%;
          text-align: center;
          box-shadow: 0 25px 50px -12px rgba(0,0,0,0.8);
          position: relative;
          animation: fadeInUp 0.3s ease-out;
        `;

        let innerHTML = `<h3 style="color: #fff; font-size: 1.5rem; margin-bottom: 1rem; font-family: Outfit, sans-serif;">${title}</h3>`;
        innerHTML += `<p style="color: var(--text-muted); margin-bottom: 2rem; font-size: 1.05rem; line-height: 1.5;">${message}</p>`;
        
        innerHTML += `<div style="display: flex; gap: 1rem; justify-content: center;">`;
        if (isConfirm) {
          innerHTML += `<button id="modalCancelBtn" class="btn btn-outline" style="flex: 1;">${cancelText}</button>`;
        }
        innerHTML += `<button id="modalConfirmBtn" class="btn btn-primary btn-glow" style="flex: 1;">${confirmText}</button>`;
        innerHTML += `</div>`;
        
        modalContent.innerHTML = innerHTML;
        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        const confirmBtn = document.getElementById("modalConfirmBtn");
        if (isConfirm) {
          const cancelBtn = document.getElementById("modalCancelBtn");
          cancelBtn.addEventListener("click", () => {
            modal.remove();
            if (onCancel) onCancel();
          });
        }

        confirmBtn.addEventListener("click", () => {
          modal.remove();
          if (onConfirm) onConfirm();
        });
      }

      window.customAlert = (message, title = "Notice") => showCustomModal({ title, message, isConfirm: false });
      window.customConfirm = (message, onConfirm, title = "Please Confirm") => showCustomModal({ title, message, isConfirm: true, onConfirm });

      // Base64 decode utility helper
      function decodeData(encodedStr) {
        try {
          return decodeURIComponent(escape(atob(encodedStr)));
        } catch(e) {
          console.error("Decoding error:", e);
          return null;
        }
      }

      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      let role = urlParams.get("role");
      let player = urlParams.get("player");
      let playerName = urlParams.get("name");
      let werewolfTeammates = urlParams.get("teammates");
      let gameRolesParam = urlParams.get("gameRoles");

      // Check if data is encapsulated in the '?data=' arg (New 2026 secure format)
      const encryptedData = urlParams.get("data");
      if (encryptedData) {
        const decodedString = decodeData(encryptedData);
        if (decodedString) {
            try {
                const parsedData = JSON.parse(decodedString);
                role = parsedData.r || role;
                player = parsedData.p || player;
                playerName = parsedData.n || playerName;
                werewolfTeammates = parsedData.t || werewolfTeammates;
                gameRolesParam = parsedData.g || gameRolesParam;
            } catch(e) {
                console.error("Failed to parse decoded JSON", e);
            }
        }
      }


      const gameRoles = gameRolesParam ? gameRolesParam.split(",") : null;

      // Role configs with updated FA icons
      const roleConfigs = {
        Werewolf: {
          iconFA: "fa-moon",
          color: "#dc2626", // Crimson
          description: "Eliminate the village each night.",
          detailedDescription: "You are a Werewolf! Work with your pack to eliminate the villagers. Blend in during the day to avoid execution."
        },
        Villager: {
          iconFA: "fa-person",
          color: "#9ca3af", // Gray
          description: "Find and eliminate the werewolves.",
          detailedDescription: "You have no special powers, but your vote is your weapon. Deduce who the wolves are before it's too late."
        },
        Seer: {
          iconFA: "fa-eye",
          color: "#3b82f6", // Blue
          description: "Nightly discover a player's true role.",
          detailedDescription: "Each night, choose one player to investigate and learn their true role. Use this info to lead the village."
        },
        Doctor: {
          iconFA: "fa-kit-medical",
          color: "#10b981", // Emerald
          description: "Protect one player each night.",
          detailedDescription: "Choose one player to protect per night. If the wolves attack them, they survive. You cannot pick the same person twice in a row."
        },
        Hunter: {
          iconFA: "fa-crosshairs",
          color: "#d97706", // Amber
          description: "If you die, you take someone with you.",
          detailedDescription: "If you are killed, quickly fire your weapon to instantly eliminate another player of your choice."
        },
        Bodyguard: {
          iconFA: "fa-shield",
          color: "#059669", // Dark emerald
          description: "Protect a player. Die in their place if needed.",
          detailedDescription: "Protect a player nightly. If wolves attack them, you die instead. Cannot protect the same person consecutively."
        },
        Cupid: {
          iconFA: "fa-heart",
          color: "#ec4899", // Pink
          description: "Link two players as lovers on night one.",
          detailedDescription: "Choose two players. If one dies, the other dies of a broken heart. They now win together."
        },
        WolfCub: {
          iconFA: "fa-dog",
          color: "#b91c1c", // Dark crimson
          description: "If you die, wolves get two kills next night.",
          detailedDescription: "You are the Wolf Cub. If the village eliminates you, the pack becomes enraged."
        },
        AlphaWolf: {
          iconFA: "fa-crown",
          color: "#7f1d1d", // Deepest crimson
          description: "The pack leader.",
          detailedDescription: "Lead the werewolves. Coordinate the attacks."
        },
        Sorceress: {
          iconFA: "fa-hat-wizard",
          color: "#8b5cf6", // Violet
          description: "Sense if a player is a werewolf.",
          detailedDescription: "Nightly investigate a player. You only learn 'Wolf' or 'Not Wolf'."
        },
        Lycan: {
          iconFA: "fa-masks-theater",
          color: "#4b5563", // Dark gray
          description: "A villager who appears as a werewolf.",
          detailedDescription: "You are a standard villager, but your curse makes you appear as a Werewolf to the Seer!"
        },
        Witch: {
          iconFA: "fa-flask",
          color: "#c026d3", // Fuchsia
          description: "One heal potion, one kill potion.",
          detailedDescription: "During the game, you can save one victim, and eliminate one suspect. Use them wisely."
        },
        Detective: {
          iconFA: "fa-magnifying-glass",
          color: "#2563eb", // Royal blue
          description: "Check if a player acted during the night.",
          detailedDescription: "Track a player and see if they visited someone. Helpful for finding active roles."
        },
        Revealer: {
          iconFA: "fa-bullseye",
          color: "#d97706", // Amber
          description: "Shoot a player. If they are innocent, you die.",
          detailedDescription: "High risk. Shoot a wolf, they die. Shoot a villager, they die AND you die as punishment."
        },
        PI: {
          iconFA: "fa-binoculars",
          color: "#0f766e", // Teal
          description: "Check a player and their two neighbors.",
          detailedDescription: "Select one player. You learn if THEY or the players beside them are wolves ('YES' or 'NO')."
        },
        Tanner: {
          iconFA: "fa-face-dizzy",
          color: "#78716c", // Stone
          description: "Your goal is to be voted out by the village.",
          detailedDescription: "You hate your life. If the village executes you, you instantly win the game alone."
        }
      };

      // UI Elements
      const card = document.getElementById('roleCard');
      const roleGlow = document.getElementById('roleGlow');
      const hideRevealBtn = document.getElementById('hideRevealBtn');
      const heartbeatSound = document.getElementById('heartbeatSound');
      
      let isRevealed = false;

      // Update basic fields immediately
      if (player) document.getElementById("playerNumber").textContent = player;
      
      const playerNameEl = document.getElementById("playerName");
      if (playerName) {
        playerNameEl.textContent = playerName;
        playerNameEl.style.display = "inline-block";
      } else {
        playerNameEl.style.display = "none";
      }

      // Populate Role Info
      function populateRoleData() {
        if (!role || !roleConfigs[role]) {
          document.getElementById('roleName').textContent = "Invalid Code";
          document.getElementById('roleDescription').textContent = "This link appears to be broken or invalid.";
          document.getElementById('roleDetailedDescription').textContent = "Ask the moderator for a new link.";
          return;
        }

        const config = roleConfigs[role];
        
        document.getElementById('roleName').textContent = role;
        document.getElementById('roleDescription').textContent = config.description;
        document.getElementById('roleDetailedDescription').textContent = config.detailedDescription;
        
        // Handle icons
        const faIcon = document.getElementById('roleIconFA');
        const emojiIcon = document.getElementById('roleIconEmoji');
        
        if (config.iconFA) {
            faIcon.className = `fa-solid ${config.iconFA}`;
            faIcon.style.display = "block";
            emojiIcon.style.display = "none";
        } else if (config.fallbackIcon) {
            faIcon.style.display = "none";
            emojiIcon.textContent = config.fallbackIcon;
            emojiIcon.style.display = "block";
        }

        // Apply theme color
        document.documentElement.style.setProperty("--role-color", config.color);
        
        // Teammates logic
        const werewolfRoles = ["Werewolf", "WolfCub", "AlphaWolf", "Sorceress"];
        const teamEl = document.getElementById("werewolfTeam");
        const matesEl = document.getElementById("werewolfTeammates");
        
        if (werewolfRoles.includes(role) && werewolfTeammates) {
          const mates = werewolfTeammates.split(",").map(t => t.trim());
          matesEl.innerHTML = mates.map(m => `<span><i class="fa-solid fa-user-ninja"></i> ${m}</span>`).join("");
          teamEl.style.display = "block";
        }
      }

      populateRoleData();

      // Card Flip Logic
      card.addEventListener('click', toggleCard);
      hideRevealBtn.addEventListener('click', toggleCard);

      function toggleCard() {
        isRevealed = !isRevealed;
        card.classList.toggle('is-flipped');
        
        if (isRevealed) {
          hideRevealBtn.style.display = "block";
          hideRevealBtn.innerHTML = '<i class="fa-solid fa-eye-slash"></i> Hide Role';
          hideRevealBtn.classList.remove('btn-primary');
          hideRevealBtn.classList.add('btn-outline');

          // Atmosphere effect
          const werewolfRoles = ["Werewolf", "WolfCub", "AlphaWolf", "Sorceress"];
          if (werewolfRoles.includes(role)) {
            roleGlow.style.background = 'radial-gradient(circle at center, rgba(220, 38, 38, 0.15) 0%, transparent 60%)';
          } else {
            roleGlow.style.background = 'radial-gradient(circle at center, rgba(59, 130, 246, 0.1) 0%, transparent 60%)';
          }
          
          // Play heartbeat for everyone to build tension
          heartbeatSound.volume = 0.5;
          heartbeatSound.play().catch(e => console.log("Audio play prevented by browser policy"));
        } else {
          hideRevealBtn.innerHTML = '<i class="fa-solid fa-eye"></i> Reveal Role';
          hideRevealBtn.classList.add('btn-primary');
          hideRevealBtn.classList.remove('btn-outline');
          roleGlow.style.background = 'transparent';
        }
      }

      // Notes System
      const notesEl = document.getElementById("playerNotes");
      const saveBtn = document.getElementById("savePlayerNotesBtn");
      
      // Use encryptedData as unique ID if available to prevent collision between games
      const storageKey = `ww_notes_${encryptedData || player}`;

      if (localStorage.getItem(storageKey)) {
        notesEl.value = localStorage.getItem(storageKey);
      }

      saveBtn.addEventListener('click', () => {
        localStorage.setItem(storageKey, notesEl.value);
        const originalHTML = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> Saved';
        setTimeout(() => saveBtn.innerHTML = originalHTML, 2000);
      });

      document.getElementById('clearPlayerNotesBtn').addEventListener('click', () => {
        window.customConfirm(
          "Erase all evidence? This will permanently delete your detective notes.",
          () => {
            notesEl.value = "";
            localStorage.removeItem(storageKey);
          },
          "Delete Evidence"
        );
      });
      
      // Role Guide for current game
      const roleInfoBtn = document.getElementById("roleInfoBtn");
      
      function showGameRoleGuide() {
        if (!gameRoles || gameRoles.length === 0) {
            window.customAlert("No game roles provided in this link. The moderator may need to regenerate the game.", "Missing Data");
            return;
        }

        const modal = document.createElement("div");
        modal.className = "role-guide-modal";
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(2, 6, 23, 0.85);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        `;

        const modalContent = document.createElement("div");
        modalContent.className = "glass-panel-inner role-guide-content";
        modalContent.style.cssText = `
          background: rgba(15, 23, 42, 0.95);
          padding: 2.5rem;
          border-radius: var(--radius-lg);
          border: 1px solid var(--glass-border);
          max-width: 90%;
          width: 800px;
          max-height: 90%;
          overflow-y: auto;
          position: relative;
          box-shadow: 0 25px 50px -12px rgba(0,0,0,0.8);
        `;

        let rolesHTML = "<h2 style='font-size: 2rem; color: #fff; margin-bottom: 2rem; text-align: center; font-family: Outfit, sans-serif;'>üìñ Roles in this Game</h2>";
        
        // Count frequencies of roles
        const roleCounts = {};
        gameRoles.forEach(r => {
            roleCounts[r] = (roleCounts[r] || 0) + 1;
        });

        // Group into categories
        const werewolfRoles = ["Werewolf", "WolfCub", "AlphaWolf", "Sorceress"];
        const villagerRoles = ["Seer", "Doctor", "Hunter", "Villager", "Bodyguard", "Cupid", "Witch", "Detective", "Revealer", "PI", "Lycan"];
        const neutralRoles = ["Tanner"];

        // Helper to generate section
        const generateSection = (title, color, bgColor, filterArr) => {
            const activeRoles = Object.keys(roleCounts).filter(r => filterArr.includes(r));
            if (activeRoles.length === 0) return "";

            let sectionHTML = `<h3 style='color: ${color}; margin-top: 2.5rem; margin-bottom: 1rem; border-bottom: 1px solid ${color}40; padding-bottom: 0.5rem; font-family: Outfit, sans-serif;'>${title}</h3>`;
            
            // Adjust top margin for the first section
            if (rolesHTML === "<h2 style='font-size: 2rem; color: #fff; margin-bottom: 2rem; text-align: center; font-family: Outfit, sans-serif;'>üìñ Roles in this Game</h2>") {
                sectionHTML = `<h3 style='color: ${color}; margin-top: 1rem; margin-bottom: 1rem; border-bottom: 1px solid ${color}40; padding-bottom: 0.5rem; font-family: Outfit, sans-serif;'>${title}</h3>`;
            }

            activeRoles.forEach(roleName => {
                const config = roleConfigs[roleName] || { iconFA: "fa-question", color: "#fff", description: "Unknown role" };
                const count = roleCounts[roleName];
                const badge = count > 1 ? `<span style="background: ${color}40; color: ${color}; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; margin-left: 0.5rem;">x${count}</span>` : "";
                
                sectionHTML += `
                  <div class="role-guide-item" style="margin-bottom: 1rem; padding: 1.25rem; border: 1px solid ${color}40; border-radius: var(--radius-sm); background: ${bgColor};">
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                      <i class="fa-solid ${config.iconFA}" style="font-size: 1.8rem; margin-right: 1rem; color: ${color};"></i>
                      <h4 style="margin: 0; color: ${color}; font-size: 1.3rem; font-family: Outfit, sans-serif;">${roleName} ${badge}</h4>
                    </div>
                    <p style="margin: 0.5rem 0; font-weight: 600; color: #fff; font-size: 0.95rem;">${config.description}</p>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">${config.detailedDescription || ''}</p>
                  </div>
                `;
            });
            return sectionHTML;
        };

        rolesHTML += generateSection("üê∫ Werewolf Team", "var(--danger)", "rgba(153, 27, 27, 0.1)", werewolfRoles);
        rolesHTML += generateSection("üë• Village Team", "var(--primary)", "rgba(30, 41, 59, 0.5)", villagerRoles);
        rolesHTML += generateSection("‚öñÔ∏è Neutral Roles", "var(--warning)", "rgba(180, 83, 9, 0.1)", neutralRoles);

        modalContent.innerHTML = `
          ${rolesHTML}
          <button onclick="this.parentElement.parentElement.remove()" style="
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(153, 27, 27, 0.8);
            color: white;
            border: 1px solid rgba(153, 27, 27, 0.4);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
          " onmouseover="this.style.background='var(--danger)'" onmouseout="this.style.background='rgba(153, 27, 27, 0.8)'">√ó</button>
        `;

        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        modal.addEventListener("click", (e) => {
          if (e.target === modal) modal.remove();
        });
      }

      if(roleInfoBtn) {
        roleInfoBtn.addEventListener("click", showGameRoleGuide);
      }
    </script>
  </body>
</html>
